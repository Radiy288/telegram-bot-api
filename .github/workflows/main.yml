name: Build Telegram Bot API Server (Windows + Linux)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-windows:
    name: ğŸªŸ Build for Windows
    runs-on: windows-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµÑ‚ TDLib

      - name: âš™ï¸ Install dependencies
        run: |
          choco install cmake git visualstudio2022buildtools -y
          refreshenv

      - name: ğŸ§± Build Telegram Bot API (via vcpkg)
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Cloning vcpkg..."
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat

          Write-Host "âš™ï¸ Installing required libs..."
          .\vcpkg.exe install gperf:x64-windows openssl:x64-windows zlib:x64-windows

          cd ..
          if (Test-Path build) { Remove-Item build -Recurse -Force }

          mkdir build
          cd build

          Write-Host "ğŸ§© Configuring CMake..."
          cmake -A x64 `
            -DCMAKE_INSTALL_PREFIX:PATH=.. `
            -DCMAKE_TOOLCHAIN_FILE:FILEPATH=../vcpkg/scripts/buildsystems/vcpkg.cmake `
            ..

          Write-Host "ğŸ—ï¸ Building project..."
          cmake --build . --target install --config Release

      - name: ğŸ“¦ Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-api-windows
          path: telegram-bot-api/bin/telegram-bot-api.exe

  build-linux:
    name: ğŸ§ Build for Linux
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # TDLib Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ½ÑƒĞ¶ĞµĞ½

      - name: âš™ï¸ Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git cmake g++ zlib1g-dev libssl-dev gperf

      - name: ğŸ§± Build Telegram Bot API
        run: |
          rm -rf build
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX:PATH=.. ..
          cmake --build . --target install -j$(nproc)

      - name: ğŸ“¦ Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-api-linux
          path: telegram-bot-api/bin/telegram-bot-api
